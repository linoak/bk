<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家庭記帳助手</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 自定義樣式補充 */
        body {
            padding-bottom: 70px;
            background-color: #f5f5f5;
            height: 100vh;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            padding: 1.5rem;
            background-color: #00d1b2;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }


        .text-red {
            color: #ff0000;
            /* 純紅色，可改成其他色碼 */
        }

        .text-blue {
            color: #3700ff7e;
            /* 純藍色，可改成其他色碼 */
        }



        /* 底部導航欄 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dbdbdb;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 20;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            text-align: center;
            color: #7a7a7a;
            cursor: pointer;
            flex: 1;
        }

        .nav-item.active {
            color: #00d1b2;
            font-weight: bold;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .nav-item span {
            font-size: 0.75rem;
            display: block;
        }

        /* 內容區域切換 */
        .page-section {
            display: none;
            padding: 1.5rem;
            animation: fadeIn 0.3s;
        }

        .page-section.active {
            display: block;
        }

        /* 日曆樣式 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-header {
            font-weight: bold;
            color: #363636;
            margin-bottom: 5px;
        }

        .calendar-day {
            border: 1px solid #eee;
            padding: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            height: 60px;
        }

        .calendar-day.today {
            border-color: #00d1b2;
            background-color: #f0fffd;
        }

        .day-income {
            color: #48c774;
            font-size: 0.7rem;
            display: block;
        }

        .day-expense {
            color: #f14668;
            font-size: 0.7rem;
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .transaction-item {
            border-bottom: 1px solid #f5f5f5;
            padding: 10px 0;
        }

        .amount-income {
            color: #48c774;
            font-weight: bold;
        }

        .amount-expense {
            color: #f14668;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="app-container">

        <div class="header">
            <h1 class="title is-4 has-text-white has-text-centered">家庭記帳助手</h1>
        </div>

        <div id="page-record" class="page-section active">
            <h2 class="subtitle is-5 text-red"><i class="fas fa-pen has-text-danger"></i> 新增紀錄</h2>
            <form id="recordForm">
                <div class="field">
                    <label class="label">類型</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="type" onchange="updateCategories()">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">日期</label>
                    <div class="control">
                        <input class="input" type="date" id="date" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">金額</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" id="amount" placeholder="輸入金額" required min="1">
                        <span class="icon is-small is-left"><i class="fas fa-dollar-sign"></i></span>
                    </div>
                </div>

                <div class="field">
                    <label class="label">分類</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="category"></select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">備註</label>
                    <div class="control">
                        <input class="input" type="text" id="note" placeholder="例如：午餐、薪水...">
                    </div>
                </div>

                <div class="field mt-5">
                    <div class="control">
                        <button type="submit" class="button is-primary is-fullwidth">儲存紀錄</button>
                    </div>
                </div>
            </form>

            <div class="notification is-success is-light mt-4 is-hidden" id="successMsg">
                紀錄已儲存！
            </div>
        </div>

        <div id="page-stats" class="page-section">
            <h2 class="subtitle is-5"><i class="fas fa-chart-pie"></i> 收支統計 (本月)</h2>
            <div class="columns is-mobile is-multiline">
                <div class="column is-6">
                    <div class="card has-background-success-light">
                        <div class="card-content p-3 has-text-centered">
                            <p class="heading">總收入</p>
                            <p class="title is-5 has-text-success" id="stat-total-income">0</p>
                        </div>
                    </div>
                </div>
                <div class="column is-6">
                    <div class="card has-background-danger-light">
                        <div class="card-content p-3 has-text-centered">
                            <p class="heading">總支出</p>
                            <p class="title is-5 has-text-danger" id="stat-total-expense">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3 class="title is-6 has-text-centered">支出分類佔比</h3>
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div id="page-calendar" class="page-section">
            <div class="level is-mobile mb-3">
                <div class="level-left">
                    <button class="button is-small" onclick="changeMonth(-1)"><i
                            class="fas fa-chevron-left"></i></button>
                </div>
                <div class="level-item">
                    <strong id="calendar-month-label" class="is-size-5">2023年 10月</strong>
                </div>
                <div class="level-right">
                    <button class="button is-small" onclick="changeMonth(1)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="calendar-grid">
                <div class="calendar-header">日</div>
                <div class="calendar-header">一</div>
                <div class="calendar-header">二</div>
                <div class="calendar-header">三</div>
                <div class="calendar-header">四</div>
                <div class="calendar-header">五</div>
                <div class="calendar-header">六</div>
            </div>
            <div id="calendar-days" class="calendar-grid">
            </div>

            <div class="modal" id="dayModal">
                <div class="modal-background" onclick="closeModal()"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title" id="modalDateTitle">詳情</p>
                        <button class="delete" aria-label="close" onclick="closeModal()"></button>
                    </header>
                    <section class="modal-card-body" id="modalContent">
                    </section>
                </div>
            </div>
        </div>

        <div id="page-budget" class="page-section">
            <h2 class="subtitle is-5"><i class="fas fa-wallet"></i> 預算管理</h2>

            <div class="box">
                <label class="label">設定每月預算上限</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="number" id="budgetInput" placeholder="輸入預算金額">
                    </div>
                    <div class="control">
                        <button class="button is-info" onclick="saveBudget()">設定</button>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3 class="title is-6">本月執行情況</h3>
                <progress class="progress is-large" id="budgetProgress" value="0" max="100"></progress>
                <div class="level is-mobile">
                    <div class="level-left">
                        <div>
                            <p class="heading">已支出</p>
                            <p class="title is-6 has-text-danger" id="budget-spent">0</p>
                        </div>
                    </div>
                    <div class="level-right has-text-right">
                        <div>
                            <p class="heading">剩餘預算</p>
                            <p class="title is-6 has-text-success" id="budget-remain">0</p>
                        </div>
                    </div>
                </div>
                <p class="help has-text-centered" id="budget-status-text"></p>
            </div>

            <div class="box">
                <h3 class="title is-6">近期紀錄 (最新5筆)</h3>
                <div id="recent-list"></div>
            </div>

            <div class="has-text-centered mt-6">
                <button class="button is-danger is-outlined is-small" onclick="clearAllData()">清除所有資料</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchPage('record')">
                <i class="fas fa-plus-circle text-blue"></i>
                <span>記帳</span>
            </div>
            <div class="nav-item" onclick="switchPage('stats')">
                <i class="fas fa-chart-pie text-blue"></i>
                <span>統計</span>
            </div>
            <div class="nav-item" onclick="switchPage('calendar')">
                <i class="fas fa-calendar-alt  text-blue"></i>
                <span>日曆</span>
            </div>
            <div class="nav-item" onclick="switchPage('budget')">
                <i class="fas fa-wallet text-blue"></i>
                <span>預算</span>
            </div>
        </nav>
    </div>

    <script>
        // --- 資料初始化與狀態管理 ---
        const expenseCategories = ["飲食", "交通", "購物", "娛樂", "居住", "醫療", "其他"];
        const incomeCategories = ["薪水", "獎金", "投資", "兼職", "其他"];

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;

        // 日曆狀態
        let currentCalendarDate = new Date();

        // Chart.js 實例
        let myChart = null;

        // --- 頁面載入初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date').valueAsDate = new Date();
            updateCategories();
            renderBudgetUI();
            document.getElementById('budgetInput').value = monthlyBudget > 0 ? monthlyBudget : '';
            renderRecentList();
        });

        // --- 1. 頁面切換與導航邏輯 ---
        function switchPage(pageId) {
            // 隱藏所有頁面
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            // 顯示目標頁面
            document.getElementById('page-' + pageId).classList.add('active');

            // 更新導航按鈕樣式
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // 簡單的比對方式，實際專案可用 dataset
            const navIndex = ['record', 'stats', 'calendar', 'budget'].indexOf(pageId);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // 切換時觸發該頁面的數據刷新
            if (pageId === 'stats') renderStats();
            if (pageId === 'calendar') renderCalendar();
            if (pageId === 'budget') renderBudgetUI();
        }

        // --- 2. 記帳功能 ---
        function updateCategories() {
            const type = document.getElementById('type').value;
            const catSelect = document.getElementById('category');
            catSelect.innerHTML = "";
            const list = type === 'expense' ? expenseCategories : incomeCategories;
            list.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                catSelect.appendChild(opt);
            });
        }

        document.getElementById('recordForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const newRecord = {
                id: Date.now(),
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                note: document.getElementById('note').value
            };

            transactions.push(newRecord);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            // 顯示成功訊息並重置
            const msg = document.getElementById('successMsg');
            msg.classList.remove('is-hidden');
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';

            setTimeout(() => msg.classList.add('is-hidden'), 2000);
            renderRecentList(); // 更新預算頁面的近期列表
        });

        // --- 3. 統計功能 ---
        function renderStats() {
            // 篩選本月數據
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7); // "YYYY-MM"

            const monthlyData = transactions.filter(t => t.date.startsWith(currentMonthStr));

            let totalIncome = 0;
            let totalExpense = 0;
            let expenseByCategory = {};

            monthlyData.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
                }
            });

            document.getElementById('stat-total-income').innerText = totalIncome;
            document.getElementById('stat-total-expense').innerText = totalExpense;

            // 繪製圖表
            const ctx = document.getElementById('expenseChart').getContext('2d');

            if (myChart) myChart.destroy(); // 銷毀舊圖表

            // 如果沒有支出數據
            if (Object.keys(expenseByCategory).length === 0) {
                // 可以繪製一個空的圖或顯示文字，這裡簡單處理
                return;
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseByCategory),
                    datasets: [{
                        data: Object.values(expenseByCategory),
                        backgroundColor: [
                            '#ff3860', '#ffdd57', '#3273dc', '#00d1b2', '#209cee', '#b86bff', '#ff9f43'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // --- 4. 日曆功能 ---
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            document.getElementById('calendar-month-label').innerText = `${year}年 ${month + 1}月`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';

            // 填充前面的空白
            for (let i = 0; i < firstDay.getDay(); i++) {
                daysContainer.innerHTML += `<div></div>`;
            }

            // 整理當月每天的收支
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const monthTrans = transactions.filter(t => t.date.startsWith(monthStr));

            // 渲染日期
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${monthStr}-${String(d).padStart(2, '0')}`;
                const dayTrans = monthTrans.filter(t => t.date === dateStr);

                let inc = 0, exp = 0;
                dayTrans.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);

                let html = `<div class="calendar-day ${dateStr === new Date().toISOString().split('T')[0] ? 'today' : ''}" onclick="showDayDetails('${dateStr}')">
                <div>${d}</div>`;

                if (inc > 0) html += `<span class="day-income">+${inc}</span>`;
                if (exp > 0) html += `<span class="day-expense">-${exp}</span>`;

                html += `</div>`;
                daysContainer.innerHTML += html;
            }
        }

        function showDayDetails(dateStr) {
            const dayTrans = transactions.filter(t => t.date === dateStr);
            const modal = document.getElementById('dayModal');
            const content = document.getElementById('modalContent');

            document.getElementById('modalDateTitle').innerText = `${dateStr} 明細`;

            if (dayTrans.length === 0) {
                content.innerHTML = '<p class="has-text-grey has-text-centered">本日無紀錄</p>';
            } else {
                content.innerHTML = dayTrans.map(t => `
                <div class="transaction-item level is-mobile mb-1">
                    <div class="level-left">
                        <div>
                            <strong>${t.category}</strong> <small class="has-text-grey">${t.note}</small>
                        </div>
                    </div>
                    <div class="level-right">
                        <span class="${t.type === 'income' ? 'amount-income' : 'amount-expense'}">
                            ${t.type === 'income' ? '+' : '-'}${t.amount}
                        </span>
                        <button class="delete ml-2 is-small" onclick="deleteTransaction(${t.id}, '${dateStr}')"></button>
                    </div>
                </div>
            `).join('');
            }

            modal.classList.add('is-active');
        }

        function closeModal() {
            document.getElementById('dayModal').classList.remove('is-active');
        }

        function deleteTransaction(id, dateStr) {
            if (confirm('確定刪除此紀錄？')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                showDayDetails(dateStr); // 重新渲染 Modal
                renderCalendar(); // 刷新日曆
                renderRecentList(); // 刷新列表
            }
        }

        // --- 5. 預算與設定 ---
        function saveBudget() {
            const val = parseFloat(document.getElementById('budgetInput').value);
            if (val >= 0) {
                monthlyBudget = val;
                localStorage.setItem('monthlyBudget', monthlyBudget);
                renderBudgetUI();
                alert('預算已更新！');
            }
        }

        function renderBudgetUI() {
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);
            const totalExpense = transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonthStr))
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('budget-spent').innerText = totalExpense;

            if (monthlyBudget > 0) {
                const remain = monthlyBudget - totalExpense;
                document.getElementById('budget-remain').innerText = remain;

                const percent = Math.min((totalExpense / monthlyBudget) * 100, 100);
                const progressBar = document.getElementById('budgetProgress');
                progressBar.value = percent;

                // 變更顏色
                progressBar.classList.remove('is-success', 'is-warning', 'is-danger');
                if (percent < 50) progressBar.classList.add('is-success');
                else if (percent < 80) progressBar.classList.add('is-warning');
                else progressBar.classList.add('is-danger');

                if (remain < 0) {
                    document.getElementById('budget-status-text').innerHTML = `<span class="has-text-danger"><i class="fas fa-exclamation-triangle"></i> 超出預算 ${Math.abs(remain)} 元</span>`;
                } else {
                    document.getElementById('budget-status-text').innerText = `預算剩餘 ${((remain / monthlyBudget) * 100).toFixed(0)}%`;
                }
            } else {
                document.getElementById('budget-remain').innerText = '-';
                document.getElementById('budgetProgress').value = 0;
                document.getElementById('budget-status-text').innerText = '尚未設定預算';
            }
        }

        function renderRecentList() {
            const list = document.getElementById('recent-list');
            // 取得最後 5 筆
            const recent = [...transactions].sort((a, b) => b.id - a.id).slice(0, 5);

            if (recent.length === 0) {
                list.innerHTML = '<p class="has-text-grey has-text-centered">尚無紀錄</p>';
                return;
            }

            list.innerHTML = recent.map(t => `
            <div class="transaction-item level is-mobile">
                <div class="level-left">
                    <div>
                        <p class="is-size-7 has-text-grey">${t.date}</p>
                        <strong>${t.category}</strong>
                    </div>
                </div>
                <div class="level-right">
                    <span class="${t.type === 'income' ? 'amount-income' : 'amount-expense'}">
                        ${t.type === 'income' ? '+' : '-'}${t.amount}
                    </span>
                </div>
            </div>
        `).join('');
        }

        function clearAllData() {
            if (confirm('警告：這將刪除所有記帳與設定資料，無法復原！確定嗎？')) {
                localStorage.clear();
                location.reload();
            }
        }

    </script>

</body>

</html>